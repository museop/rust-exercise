use tokio::io::{AsyncReadExt, AsyncWriteExt};
use tokio::net::TcpListener;

// í´ë¼ì´ì–¸íŠ¸ì—ì„œ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë°©ë²•:
// # í„°ë¯¸ë„ A (ì„œë²„)
// $ cargo run
// # í„°ë¯¸ë„ B (í´ë¼ì´ì–¸íŠ¸ 1)
// $ nc 127.0.0.1 8080
// ì•ˆë…•?
// ì•ˆë…•?  <-- ë‚´ê°€ ì¹œ ê¸€ìê°€ ì„œë²„ ê°”ë‹¤ê°€ ë‹¤ì‹œ ëŒì•„ì˜´
#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    // 1. IP ì£¼ì†Œ ë°”ì¸ë”© (ìˆ˜ì‹  ëŒ€ê¸° ì‹œì‘)
    let listener = TcpListener::bind("127.0.0.1:8080").await?;
    println!("ğŸš€ ì—ì½” ì„œë²„ê°€ 127.0.0.1:8080 ì—ì„œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.");

    loop {
        // 2. í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ìˆ˜ë½ (accept)
        // ìƒˆë¡œìš´ í´ë¼ì´ì–¸íŠ¸ê°€ ì˜¬ ë•Œê¹Œì§€ ì—¬ê¸°ì„œ ëŒ€ê¸°í•˜ì§€ë§Œ, ë‹¤ë¥¸ ë¹„ë™ê¸° ì‘ì—…ì€ ë°©í•´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        let (mut socket, addr) = listener.accept().await?;
        println!("âœ¨ ìƒˆë¡œìš´ ì ‘ì†: {}", addr);

        // 3. ë™ì‹œì„± ë¶€ì—¬ (Phase 2 ë³µìŠµ)
        // spawnì„ ì•ˆ ì“°ë©´ ì´ í´ë¼ì´ì–¸íŠ¸ ì²˜ë¦¬ê°€ ëë‚  ë•Œê¹Œì§€ ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ë¥¼ ëª» ë°›ìŠµë‹ˆë‹¤.
        // spawnì„ ì¼ê°œ ë•Œë¬¸ì— ì¦‰ì‹œ ë‹¤ìŒ loopë¡œ ëŒì•„ê°€ì„œ ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        tokio::spawn(async move {
            let mut buf = [0; 1024]; // 1KB ë²„í¼

            // 4. ë°ì´í„° ì½ê³  ì“°ê¸° ë°˜ë³µ
            loop {
                // ì†Œì¼“ì—ì„œ ë°ì´í„°ë¥¼ ì½ì–´ bufì— ì €ì¥
                // move í‚¤ì›Œë“œ: socket ë³€ìˆ˜ëŠ” ì²˜ìŒì— ë©”ì¸ í•¨ìˆ˜ì— ìˆì—ˆì§€ë§Œ,
                // async moveë¥¼ í†µí•´ ìƒˆë¡œ ìƒì„±ëœ íƒœìŠ¤í¬ ë‚´ë¶€ë¡œ ì†Œìœ ê¶Œì´ ì´ë™
                // ì´ì œ ì†Œì¼“ì€ í•´ë‹¹ íƒœìŠ¤í¬ê°€ ì±…ì„ì§€ê³  ê´€ë¦¬í•˜ë‹¤ê°€, íƒœìŠ¤í¬ê°€ ëë‚˜ë©´(ì—°ê²°ì´ ëŠê¸°ë©´)
                // ìë™ìœ¼ë¡œ ë©”ëª¨ë¦¬ì—ì„œ í•´ì œ(Drop)ë©ë‹ˆë‹¤.
                match socket.read(&mut buf).await {
                    // ì½ì€ ë°”ì´íŠ¸ ìˆ˜(n)ê°€ 0ì´ë©´ ì—°ê²°ì´ ëŠì¼°ë‹¤ëŠ” ëœ» (EOF)
                    Ok(n) if n == 0 => return,
                    // ë°ì´í„°ê°€ ë“¤ì–´ì˜¤ë©´ ê·¸ëŒ€ë¡œ ë‹¤ì‹œ ì „ì†¡ (Echo)
                    Ok(n) => {
                        // write_allì€ ëª¨ë“  ë°ì´í„°ê°€ ì „ì†¡ë  ë•Œê°€ì§€ ë¹„ë™ê¸°ì ìœ¼ë¡œ ê¸°ë‹¤ë¦¼
                        if let Err(e) = socket.write_all(&buf[0..n]).await {
                            eprintln!("ë°ì´í„° ì „ì†¡ ì˜¤ë¥˜: {}", e);
                            return;
                        }
                    }
                    Err(e) => {
                        eprintln!("ë°ì´í„° ìˆ˜ì‹  ì˜¤ë¥˜: {}", e);
                        return;
                    }
                }
            }
        });
    }
}
